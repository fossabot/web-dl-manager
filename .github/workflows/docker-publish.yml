name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build_and_push:
    name: 构建并推送镜像 (${{ matrix.version }})
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        version: [standard, full]
    permissions:
      contents: read
      packages: write
    steps:
      - name: 检出代码库
        uses: actions/checkout@v3
        with:
          fetch-depth: 2

      - name: 检查 CHANGELOG.md 是否已修改
        id: check_changelog
        run: |
          if git diff --name-only HEAD^ HEAD | grep -q "CHANGELOG.md"; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md 已修改。"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "CHANGELOG.md 未修改。"
          fi

      - name: 从 CHANGELOG 提取版本号
        id: extract_version
        if: steps.check_changelog.outputs.changed == 'true'
        run: |
          # 修正 sed 提取逻辑，更鲁棒地获取 [x.y.z] 格式
          VERSION=$(grep -m1 '## \[' CHANGELOG.md | sed -E 's/## \[([^]]+)\].*/\1/')
          if [ -z "$VERSION" ]; then
            echo "无法从 CHANGELOG.md 提取版本号"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "找到版本号：$VERSION"

      - name: 登录 GitHub 容器注册表
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 提取 Docker 元数据
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ghcr.io/jyf0214/web-dl-manager
          flavor: |
            suffix=${{ matrix.version == 'full' && '-full' || '' }},onlatest=true
          tags: |
            type=raw,value=${{ steps.extract_version.outputs.version }},enable=${{ steps.check_changelog.outputs.changed == 'true' }}
            type=raw,value=stable,enable=${{ steps.check_changelog.outputs.changed == 'true' }}
            type=raw,value=latest
            type=raw,value=dev,enable=${{ steps.check_changelog.outputs.changed != 'true' }}

      - name: 构建并推送 Docker 镜像
        uses: docker/build-push-action@v4
        with:
          context: .
          no-cache: true
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            MODE=true
            INSTALL_NODE=${{ matrix.version == 'full' && 'true' || 'false' }}

  # 重启 Hugging Face Space 任务，确保在所有镜像（包括全量包）构建完成后执行
  rebuild_hf_space:
    name: 重启 Hugging Face Space
    needs: build_and_push
    # 仅在主仓库的 main 分支推送时触发，且需要 build_and_push 成功完成（含 standard 和 full）
    if: github.repository == 'Jyf0214/web-dl-manager' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: 触发工厂级重启 (Factory Rebuild)
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $HF_TOKEN" \
            "https://huggingface.co/api/spaces/$HF_SPACE_ID/restart?factory=true")

          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ 成功触发目标 Space 重建。(HTTP 200)"
          else
            echo "❌ 触发重建失败。(HTTP $HTTP_CODE)"
          fi