<!DOCTYPE html>
<html lang="{{ lang.get('lang_code', 'en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lang.app_title }} - 更新管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <!-- 导航栏 -->
    {% include 'components/navbar.html' %}
    
    <div class="container-main">
        <div class="page-header fade-in">
            <h1 class="display-4 mb-3">
                <i class="bi bi-cloud-arrow-up"></i> 更新管理
            </h1>
            <p class="lead">Web-DL-Manager 应用更新和依赖管理</p>
        </div>

        <!-- 状态卡片 -->
        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-info-circle"></i> 当前状态</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1"><strong>当前版本</strong></p>
                                <h3 id="current-version" class="text-primary">检查中...</h3>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>最新版本</strong></p>
                                <h3 id="latest-version" class="text-success">检查中...</h3>
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="mb-1"><strong>更新状态</strong></p>
                            <div id="update-status" class="alert alert-info mb-0">
                                <i class="bi bi-hourglass-split"></i> 正在检查更新...
                            </div>
                        </div>
                        <div class="mt-3">
                            <p class="mb-1"><strong>最后更新时间</strong></p>
                            <p id="last-update-time" class="text-muted">未知</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="bi bi-boxes"></i> 依赖信息</h5>
                    </div>
                    <div class="card-body">
                        <p class="mb-1"><strong>依赖数量</strong></p>
                        <h3 id="dependencies-count" class="text-success">检查中...</h3>
                        <p class="text-muted small mt-1 mb-3">requirements.txt 中的依赖包数量</p>
                        
                        <div class="d-grid gap-2">
                            <button id="check-updates-btn" class="btn btn-primary">
                                <i class="bi bi-search"></i> 检查更新
                            </button>
                            <button id="update-app-btn" class="btn btn-success" disabled>
                                <i class="bi bi-download"></i> 更新应用
                            </button>
                            <button id="update-deps-btn" class="btn btn-warning">
                                <i class="bi bi-arrow-repeat"></i> 更新依赖库
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 更新日志 -->
        <div class="card mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-journal-text"></i> 更新日志</h5>
                <button id="refresh-changelog-btn" class="btn btn-light btn-sm">
                    <i class="bi bi-arrow-clockwise"></i> 刷新
                </button>
            </div>
            <div class="card-body">
                <div class="log-container" id="changelog-content" style="height: 300px;">
                    正在加载更新日志...
                </div>
            </div>
        </div>

        <!-- 更新历史 -->
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> 更新历史</h5>
            </div>
            <div class="card-body">
                <div id="update-history">
                    <p class="text-muted mb-0">暂无更新历史记录</p>
                </div>
            </div>
        </div>

        <!-- 操作说明 -->
        <div class="alert alert-light mt-4">
            <h6><i class="bi bi-lightbulb"></i> 操作说明</h6>
            <ul class="mb-0">
                <li><strong>检查更新</strong>: 从 GitHub 仓库检查是否有新版本可用</li>
                <li><strong>更新应用</strong>: 下载最新代码文件并重启应用（仅当有更新可用时启用）</li>
                <li><strong>更新依赖库</strong>: 更新 requirements.txt 中的所有 Python 依赖包</li>
                <li>更新过程中请勿关闭页面，更新完成后应用会自动重启</li>
            </ul>
        </div>
    </div>

    <!-- 模态框 - 更新确认 -->
    <div class="modal fade" id="updateConfirmModal" tabindex="-1" aria-labelledby="updateConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="updateConfirmModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> 确认更新
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要更新应用吗？</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> 更新过程中：
                        <ul class="mb-0">
                            <li>应用将下载最新代码文件</li>
                            <li>将更新 Python 依赖包</li>
                            <li>应用将自动重启</li>
                            <li>重启过程可能需要几秒钟</li>
                        </ul>
                    </div>
                    <p class="mb-0"><strong>更新摘要</strong></p>
                    <div id="update-summary" class="bg-light p-2 rounded small">
                        正在获取更新信息...
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="confirm-update-btn">
                        <i class="bi bi-download"></i> 确认更新
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框 - 依赖更新确认 -->
    <div class="modal fade" id="depsUpdateConfirmModal" tabindex="-1" aria-labelledby="depsUpdateConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="depsUpdateConfirmModalLabel">
                        <i class="bi bi-exclamation-triangle text-warning"></i> 确认更新依赖
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要更新 Python 依赖库吗？</p>
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle"></i> 依赖更新过程中：
                        <ul class="mb-0">
                            <li>将根据 requirements.txt 更新所有 Python 包</li>
                            <li>可能需要几分钟时间</li>
                            <li>不会重启应用</li>
                            <li>请确保 requirements.txt 文件配置正确</li>
                        </ul>
                    </div>
                    <p class="mb-0"><strong>依赖文件</strong></p>
                    <div class="bg-light p-2 rounded small">
                        {{ lang.powered_by }} - requirements.txt
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-warning" id="confirm-deps-update-btn">
                        <i class="bi bi-arrow-repeat"></i> 确认更新依赖
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let updateAvailable = false;
        let currentVersion = 'N/A';
        let latestVersion = 'N/A';
        let commitsBehind = 0;

        // DOM 元素
        const checkUpdatesBtn = document.getElementById('check-updates-btn');
        const updateAppBtn = document.getElementById('update-app-btn');
        const updateDepsBtn = document.getElementById('update-deps-btn');
        const refreshChangelogBtn = document.getElementById('refresh-changelog-btn');
        const confirmUpdateBtn = document.getElementById('confirm-update-btn');
        const confirmDepsUpdateBtn = document.getElementById('confirm-deps-update-btn');
        const updateSummary = document.getElementById('update-summary');

        // 加载更新信息
        async function loadUpdateInfo() {
            try {
                const response = await fetch('/api/updates/info');
                const data = await response.json();
                
                if (data.status === 'success') {
                    // 更新基本信息
                    document.getElementById('current-version').textContent = data.current_version;
                    document.getElementById('latest-version').textContent = data.latest_version;
                    document.getElementById('dependencies-count').textContent = data.dependencies_count || '0';
                    
                    if (data.last_update_time) {
                        const date = new Date(data.last_update_time);
                        document.getElementById('last-update-time').textContent = date.toLocaleString();
                    }
                    
                    // 更新状态显示
                    updateAvailable = data.update_available;
                    currentVersion = data.current_version;
                    latestVersion = data.latest_version;
                    commitsBehind = data.commits_behind || 0;
                    
                    const updateStatusEl = document.getElementById('update-status');
                    if (updateAvailable) {
                        updateStatusEl.className = 'alert alert-warning mb-0';
                        updateStatusEl.innerHTML = `<i class="bi bi-arrow-up-circle"></i> 有可用更新！落后 ${commitsBehind} 个提交`;
                        updateAppBtn.disabled = false;
                    } else {
                        updateStatusEl.className = 'alert alert-success mb-0';
                        updateStatusEl.innerHTML = `<i class="bi bi-check-circle"></i> 已是最新版本`;
                        updateAppBtn.disabled = true;
                    }
                } else {
                    showError('获取更新信息失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                showError('加载更新信息时出错: ' + error.message);
            }
        }

        // 加载更新日志
        async function loadChangelog() {
            try {
                const response = await fetch('/api/changelog');
                const text = await response.text();
                document.getElementById('changelog-content').textContent = text;
            } catch (error) {
                document.getElementById('changelog-content').textContent = '加载更新日志失败: ' + error.message;
            }
        }

        // 检查更新
        async function checkForUpdates() {
            try {
                checkUpdatesBtn.disabled = true;
                checkUpdatesBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 检查中...';
                
                const response = await fetch('/api/updates/check');
                const data = await response.json();
                
                if (data.status === 'success') {
                    updateAvailable = data.update_available;
                    currentVersion = data.current_version;
                    latestVersion = data.latest_version;
                    commitsBehind = data.commits_behind || 0;
                    
                    const updateStatusEl = document.getElementById('update-status');
                    if (updateAvailable) {
                        updateStatusEl.className = 'alert alert-warning mb-0';
                        updateStatusEl.innerHTML = `<i class="bi bi-arrow-up-circle"></i> 有可用更新！落后 ${commitsBehind} 个提交`;
                        updateAppBtn.disabled = false;
                    } else {
                        updateStatusEl.className = 'alert alert-success mb-0';
                        updateStatusEl.innerHTML = `<i class="bi bi-check-circle"></i> 已是最新版本`;
                        updateAppBtn.disabled = true;
                    }
                    
                    document.getElementById('current-version').textContent = currentVersion;
                    document.getElementById('latest-version').textContent = latestVersion;
                    
                    showSuccess('检查完成: ' + (updateAvailable ? '发现新版本' : '已是最新版本'));
                } else {
                    showError('检查更新失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                showError('检查更新时出错: ' + error.message);
            } finally {
                checkUpdatesBtn.disabled = false;
                checkUpdatesBtn.innerHTML = '<i class="bi bi-search"></i> 检查更新';
            }
        }

        // 更新应用
        async function updateApplication() {
            try {
                updateAppBtn.disabled = true;
                updateAppBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 更新中...';
                
                const response = await fetch('/api/update', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showSuccess('更新成功！应用将在几秒后重启...');
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    showError('更新失败: ' + (data.message || '未知错误'));
                    updateAppBtn.disabled = false;
                    updateAppBtn.innerHTML = '<i class="bi bi-download"></i> 更新应用';
                }
            } catch (error) {
                showError('更新应用时出错: ' + error.message);
                updateAppBtn.disabled = false;
                updateAppBtn.innerHTML = '<i class="bi bi-download"></i> 更新应用';
            }
        }

        // 更新依赖库
        async function updateDependencies() {
            try {
                updateDepsBtn.disabled = true;
                updateDepsBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> 更新中...';
                
                const response = await fetch('/api/updates/dependencies', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.status === 'success') {
                    showSuccess('依赖更新成功！');
                } else {
                    showError('依赖更新失败: ' + (data.message || '未知错误'));
                }
            } catch (error) {
                showError('更新依赖时出错: ' + error.message);
            } finally {
                updateDepsBtn.disabled = false;
                updateDepsBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i> 更新依赖库';
            }
        }

        // 显示成功消息
        function showSuccess(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-main').prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // 显示错误消息
        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show';
            alertDiv.innerHTML = `
                <i class="bi bi-exclamation-triangle"></i> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.querySelector('.container-main').prepend(alertDiv);
            setTimeout(() => alertDiv.remove(), 5000);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载初始数据
            loadUpdateInfo();
            loadChangelog();
            
            // 绑定事件
            checkUpdatesBtn.addEventListener('click', checkForUpdates);
            updateDepsBtn.addEventListener('click', function() {
                const modal = new bootstrap.Modal(document.getElementById('depsUpdateConfirmModal'));
                modal.show();
            });
            refreshChangelogBtn.addEventListener('click', loadChangelog);
            
            // 更新应用按钮点击 - 显示确认模态框
            updateAppBtn.addEventListener('click', function() {
                if (updateAvailable) {
                    // 准备更新摘要
                    updateSummary.textContent = `从版本 ${currentVersion} 更新到 ${latestVersion}，包含 ${commitsBehind} 个提交`;
                    const modal = new bootstrap.Modal(document.getElementById('updateConfirmModal'));
                    modal.show();
                }
            });
            
            // 确认更新按钮
            confirmUpdateBtn.addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('updateConfirmModal'));
                modal.hide();
                updateApplication();
            });
            
            // 确认更新依赖按钮
            confirmDepsUpdateBtn.addEventListener('click', function() {
                const modal = bootstrap.Modal.getInstance(document.getElementById('depsUpdateConfirmModal'));
                modal.hide();
                updateDependencies();
            });
            
            // 自动检查更新（每30分钟一次）
            setInterval(checkForUpdates, 30 * 60 * 1000);
        });
    </script>
</body>
</html>