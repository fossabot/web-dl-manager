<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 1.5rem; }
        .progress-bar { transition: width 0.5s ease-in-out; }
    </style>
</head>
<body>
    {% include 'downloader.html' %}

    <div class="container mt-4">
        <h1 class="mb-4">Server Status</h1>

        <!-- System Information -->
        <div class="row">
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">System Information</div>
                    <div class="card-body">
                        <p><strong>Uptime:</strong> <span id="uptime">Loading...</span></p>
                        <p><strong>Active Tasks:</strong> <span id="active-tasks">Loading...</span></p>
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">Dependency Versions</div>
                    <div class="card-body">
                        <p><strong>Python:</strong> <span id="python-version">Loading...</span></p>
                        <p><strong>gallery-dl:</strong> <span id="gallery-dl-version">Loading...</span></p>
                        <p><strong>rclone:</strong> <span id="rclone-version">Loading...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resource Usage -->
        <div class="row">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">CPU Usage</div>
                    <div class="card-body">
                        <div class="progress">
                            <div id="cpu-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="text-center mt-2"><span id="cpu-percent">0</span>%</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">Memory Usage</div>
                    <div class="card-body">
                        <div class="progress">
                            <div id="mem-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="text-center mt-2"><span id="mem-used">0</span> / <span id="mem-total">0</span> GB (<span id="mem-percent">0</span>%)</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">/data Disk Usage</div>
                    <div class="card-body">
                        <div class="progress">
                            <div id="disk-progress" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <p class="text-center mt-2"><span id="disk-used">0</span> / <span id="disk-total">0</span> GB (<span id="disk-percent">0</span>%)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function formatBytes(bytes, decimals = 2) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const dm = decimals < 0 ? 0 : decimals;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }

        async function fetchStatus() {
            try {
                const response = await fetch('/server-status/json');
                const data = await response.json();

                // System Info
                document.getElementById('uptime').textContent = data.system.uptime;
                document.getElementById('active-tasks').textContent = data.application.active_tasks;

                // Versions
                document.getElementById('python-version').textContent = data.application.versions.python;
                document.getElementById('gallery-dl-version').textContent = data.application.versions['gallery-dl'];
                document.getElementById('rclone-version').textContent = data.application.versions.rclone;

                // CPU
                const cpuPercent = data.system.cpu_usage.toFixed(1);
                document.getElementById('cpu-progress').style.width = cpuPercent + '%';
                document.getElementById('cpu-progress').setAttribute('aria-valuenow', cpuPercent);
                document.getElementById('cpu-percent').textContent = cpuPercent;

                // Memory
                const mem = data.system.memory;
                document.getElementById('mem-progress').style.width = mem.percent + '%';
                document.getElementById('mem-progress').setAttribute('aria-valuenow', mem.percent);
                document.getElementById('mem-used').textContent = formatBytes(mem.used);
                document.getElementById('mem-total').textContent = formatBytes(mem.total);
                document.getElementById('mem-percent').textContent = mem.percent.toFixed(1);

                // Disk
                const disk = data.system.disk;
                const diskPercent = disk.percent.toFixed(1);
                document.getElementById('disk-progress').style.width = diskPercent + '%';
                document.getElementById('disk-progress').setAttribute('aria-valuenow', diskPercent);
                document.getElementById('disk-used').textContent = formatBytes(disk.used);
                document.getElementById('disk-total').textContent = formatBytes(disk.total);
                document.getElementById('disk-percent').textContent = diskPercent;

            } catch (error) {
                console.error('Error fetching server status:', error);
            }
        }

        // Fetch status on page load and then every 5 seconds
        document.addEventListener('DOMContentLoaded', () => {
            fetchStatus();
            setInterval(fetchStatus, 5000);
        });
    </script>
</body>
</html>
