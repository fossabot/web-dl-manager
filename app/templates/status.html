<!DOCTYPE html>
<html lang="{{ lang.get('lang_code', 'en') }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ lang.job_status_title }} - {{ task_id }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/static/css/style.css">
    <style>
        .log-header {
            cursor: pointer;
            user-select: none;
        }
        .log-header:hover {
            color: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    {% include 'components/navbar.html' %}
    
    <div class="container-main">
        <div class="card fade-in">
            <div class="card-body">
                <h1 class="card-title mb-4">
                    <i class="bi bi-activity"></i> {{ lang.job_status_title }}
                </h1>
                <p class="text-muted">{{ lang.task_id_label }} <span class="font-monospace">{{ task_id }}</span></p>
                        
                        <div class="d-flex justify-content-end align-items-center mb-2">
                            <button class="btn btn-sm btn-outline-secondary me-2" id="decrease-font-size">A-</button>
                            <button class="btn btn-sm btn-outline-secondary" id="increase-font-size">A+</button>
                        </div>

                        <div class="mb-3">
                            <h5 class="log-header" data-bs-toggle="collapse" data-bs-target="#downloadLogCollapse" aria-expanded="true" aria-controls="downloadLogCollapse">
                                <i class="bi bi-caret-down-fill"></i> Download Log
                            </h5>
                            <div class="collapse show" id="downloadLogCollapse">
                                <div class="position-relative">
                                    <div id="log-container" class="p-3"><code>
                                        {% if log_content %}
                                            {% for line in log_content.split('\n') %}
                                                <div class="log-line">{{ line }}</div>
                                            {% endfor %}
                                        {% endif %}
                                    </code></div>
                                    <button class="btn btn-light btn-sm position-absolute top-0 end-0 m-2" id="copy-download-log-button" title="{{ lang.copy_button }}">
                                        <i class="bi bi-clipboard"></i> {{ lang.copy_button }}
                                    </button>
                                </div>
                            </div>
                        </div>



                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <a href="/" class="btn btn-primary">{{ lang.start_new_job_button }}</a>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" role="switch" id="auto-refresh-switch" checked>
                                <label class="form-check-label" for="auto-refresh-switch">{{ lang.auto_refresh_label }}</label>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="footer">
                    <p class="text-muted">{{ lang.powered_by }}</p>
                </div>
            </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        const taskId = "{{ task_id }}";
        const downloadLogContainer = document.getElementById('log-container');
        const downloadLogContentElement = downloadLogContainer.querySelector('code');

        const copyDownloadLogButton = document.getElementById('copy-download-log-button');
        const copyErrorLogButton = document.getElementById('copy-error-log-button');
        const autoRefreshSwitch = document.getElementById('auto-refresh-switch');
        const decreaseFontSizeButton = document.getElementById('decrease-font-size');
        const increaseFontSizeButton = document.getElementById('increase-font-size');
        let intervalId;
        let isUserScrolling = false;
        let scrollTimer = null;
        let isTaskCompleted = false;

        function renderLog(logElement, logContent) {
            logElement.innerHTML = ''; // Clear previous content
            const lines = logContent.split('\n');
            lines.forEach(line => {
                const lineDiv = document.createElement('div');
                lineDiv.className = 'log-line';
                lineDiv.textContent = line;
                logElement.appendChild(lineDiv);
            });
        }

        async function fetchLogs() {
            try {
                const response = await fetch(`/api/status/${taskId}/json?t=${new Date().getTime()}`);
                if (response.ok) {
                    const data = await response.json();
                    renderLog(downloadLogContentElement, data.log);
                    
                    // Auto-scroll only if user is not manually scrolling
                    if (!isUserScrolling) {
                        downloadLogContainer.scrollTop = downloadLogContainer.scrollHeight;
                    }

                    // Check if task is completed
                    if (!isTaskCompleted && data.status && data.status.status) {
                        const taskStatus = data.status.status;
                        if (taskStatus === 'completed' || taskStatus === 'failed') {
                            isTaskCompleted = true;
                            stopAutoRefresh();
                            autoRefreshSwitch.checked = false;
                            
                            // Show completion message
                            const statusDiv = document.createElement('div');
                            statusDiv.className = taskStatus === 'completed' 
                                ? 'alert alert-success mt-3' 
                                : 'alert alert-danger mt-3';
                            statusDiv.innerHTML = `<i class="bi bi-info-circle"></i> Task ${taskStatus}. Auto-refresh stopped.`;
                            downloadLogContentElement.appendChild(statusDiv);
                        }
                    }

                } else {
                    console.error('Failed to fetch logs:', response.statusText);
                }
            } catch (error) {
                console.error('Error fetching logs:', error);
            }
        }

        function startAutoRefresh() {
            if (!intervalId) {
                intervalId = setInterval(fetchLogs, 2000); // Refresh every 2 seconds
            }
        }

        function stopAutoRefresh() {
            if (intervalId) {
                clearInterval(intervalId);
                intervalId = null;
            }
        }

        function changeFontSize(amount) {
            const logContainers = [downloadLogContainer];
            logContainers.forEach(container => {
                const currentSize = parseFloat(window.getComputedStyle(container, null).getPropertyValue('font-size'));
                container.style.fontSize = (currentSize + amount) + 'px';
            });
        }

        autoRefreshSwitch.addEventListener('change', () => {
            if (autoRefreshSwitch.checked) {
                startAutoRefresh();
            } else {
                stopAutoRefresh();
            }
        });

        decreaseFontSizeButton.addEventListener('click', () => changeFontSize(-1));
        increaseFontSizeButton.addEventListener('click', () => changeFontSize(1));

        function setupCopyButton(button, contentElement) {
            button.addEventListener('click', () => {
                navigator.clipboard.writeText(contentElement.textContent).then(() => {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i> {{ lang.copied_button }}';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        }

        setupCopyButton(copyDownloadLogButton, downloadLogContentElement);

        function setupCopyErrorButton(button, contentElement) {
            button.addEventListener('click', () => {
                const allText = contentElement.textContent;
                const lines = allText.split('\n');
                const errorLines = lines.filter(line => 
                    line.includes('ERROR') || 
                    line.includes('FAILED') || 
                    line.includes('Exception') || 
                    line.includes('Traceback') || 
                    line.includes('错误') ||
                    line.includes('失败')
                );
                const errorText = errorLines.join('\n');
                navigator.clipboard.writeText(errorText).then(() => {
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="bi bi-check-lg"></i> {{ lang.copied_button }}';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy text: ', err);
                });
            });
        }

        setupCopyErrorButton(copyErrorLogButton, downloadLogContentElement);

        function handleLineClick(event) {
            const target = event.target;
            if (target.classList.contains('log-line')) {
                // Remove 'selected' from other lines in the same container
                const container = target.parentElement;
                container.querySelectorAll('.log-line.selected').forEach(line => {
                    line.classList.remove('selected');
                });
                // Add 'selected' to the clicked line
                target.classList.add('selected');
            }
        }

        downloadLogContentElement.addEventListener('click', handleLineClick);

        // User scrolling detection
        function handleLogScroll() {
            isUserScrolling = true;
            
            // Clear previous timer
            if (scrollTimer) {
                clearTimeout(scrollTimer);
            }
            
            // Reset user scrolling flag after 2 seconds of inactivity
            scrollTimer = setTimeout(() => {
                isUserScrolling = false;
            }, 2000);
        }

        downloadLogContainer.addEventListener('scroll', handleLogScroll);

        // Initial fetch and start auto-refresh
        fetchLogs();
        startAutoRefresh();

        // Handle collapse icon change
        document.querySelectorAll('.log-header').forEach(header => {
            header.addEventListener('click', () => {
                const icon = header.querySelector('i');
                if (icon.classList.contains('bi-caret-down-fill')) {
                    icon.classList.remove('bi-caret-down-fill');
                    icon.classList.add('bi-caret-right-fill');
                } else {
                    icon.classList.remove('bi-caret-right-fill');
                    icon.classList.add('bi-caret-down-fill');
                }
            });
        });
    </script>
</body>
</html>