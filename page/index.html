<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web-DL Manager Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6',
                        dark: '#0f172a',
                        'dark-lighter': '#1e293b'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="bg-dark text-slate-200 min-h-screen custom-scrollbar">

    <!-- Header -->
    <header class="sticky top-0 z-50 glass-card border-b border-slate-800 px-6 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center shadow-lg shadow-primary/20">
                <i class="bi bi-cloud-arrow-down-fill text-white text-xl"></i>
            </div>
            <h1 class="text-xl font-bold tracking-tight">Web-DL <span class="text-primary">Manager</span></h1>
        </div>
        
        <div class="flex items-center space-x-4">
            <div id="connection-status" class="flex items-center space-x-2 text-sm px-3 py-1.5 rounded-full bg-red-500/10 text-red-400 border border-red-500/20">
                <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                <span>未连接</span>
            </div>
            <button onclick="document.getElementById('config-modal').classList.remove('hidden')" class="p-2 rounded-lg hover:bg-slate-800 transition-colors">
                <i class="bi bi-gear text-lg"></i>
            </button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto p-6 space-y-8">
        
        <!-- Stats Row -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-slate-400 text-sm mb-1">活跃任务</p>
                <p id="stat-tasks" class="text-3xl font-bold text-primary">0</p>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-slate-400 text-sm mb-1">CPU 使用率</p>
                <p id="stat-cpu" class="text-3xl font-bold text-emerald-400">0%</p>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-slate-400 text-sm mb-1">内存占用</p>
                <p id="stat-mem" class="text-3xl font-bold text-amber-400">0%</p>
            </div>
            <div class="glass-card p-6 rounded-2xl">
                <p class="text-slate-400 text-sm mb-1">磁盘剩余</p>
                <p id="stat-disk" class="text-3xl font-bold text-blue-400">0 GB</p>
            </div>
        </div>

        <!-- Action Bar -->
        <div class="flex flex-col md:flex-row gap-4 items-center justify-between">
            <h2 class="text-2xl font-bold">任务列表</h2>
            <button onclick="document.getElementById('new-task-modal').classList.remove('hidden')" class="w-full md:w-auto px-6 py-2.5 bg-primary hover:bg-primary/90 text-white rounded-xl font-semibold transition-all flex items-center justify-center space-x-2 shadow-lg shadow-primary/30">
                <i class="bi bi-plus-lg"></i>
                <span>新建任务</span>
            </button>
        </div>

        <!-- Task List Container -->
        <div id="task-list" class="grid grid-cols-1 gap-4">
            <!-- Tasks will be injected here -->
            <div class="py-20 text-center text-slate-500">
                <i class="bi bi-inbox text-5xl mb-4 block"></i>
                <p>正在拉取任务列表...</p>
            </div>
        </div>
    </main>

    <!-- New Task Modal -->
    <div id="new-task-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4 bg-black/60 backdrop-blur-sm">
        <div class="glass-card w-full max-w-lg rounded-2xl shadow-2xl p-8 space-y-6">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold">创建下载任务</h3>
                <button onclick="document.getElementById('new-task-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="bi bi-x-lg"></i></button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1.5">目标 URL</label>
                    <input id="new-url" type="text" placeholder="https://..." class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1.5">下载器</label>
                        <select id="new-downloader" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none">
                            <option value="gallery-dl">gallery-dl</option>
                            <option value="megadl">megadl</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-400 mb-1.5">上传服务</label>
                        <select id="new-service" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none">
                            <option value="gofile">gofile.io</option>
                            <option value="openlist">openlist</option>
                            <option value="webdav">WebDAV</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1.5">远程路径</label>
                    <input id="new-path" type="text" placeholder="archives/downloads" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all">
                </div>

                <div class="flex items-center space-x-2">
                    <input type="checkbox" id="new-compress" checked class="w-5 h-5 rounded border-slate-700 bg-slate-900 text-primary focus:ring-primary">
                    <label for="new-compress" class="text-sm text-slate-300">启用 Zstd 压缩</label>
                </div>
            </div>

            <button onclick="submitNewTask()" class="w-full py-3.5 bg-primary hover:bg-primary/90 text-white rounded-xl font-bold transition-all shadow-lg shadow-primary/30">
                开始下载
            </button>
        </div>
    </div>

    <!-- Config Modal -->
    <div id="config-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4 bg-black/60 backdrop-blur-sm">
        <div class="glass-card w-full max-w-md rounded-2xl shadow-2xl p-8 space-y-6">
            <h3 class="text-xl font-bold">后端连接配置</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-400 mb-1.5">API 基础地址</label>
                    <input id="api-base" type="text" placeholder="http://ip:6275" class="w-full bg-slate-900/50 border border-slate-700 rounded-xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary/50">
                    <p class="text-xs text-slate-500 mt-2">如果是本地运行，通常为 http://localhost:6275</p>
                </div>
            </div>
            <button onclick="saveConfig()" class="w-full py-3.5 bg-slate-700 hover:bg-slate-600 text-white rounded-xl font-bold transition-all">
                保存并重连
            </button>
        </div>
    </div>

    <script>
        let apiBase = localStorage.getItem('wdm_api_base') || window.location.origin;
        if (apiBase.endsWith('/')) apiBase = apiBase.slice(0, -1);

        const state = {
            tasks: [],
            stats: null
        };

        async function fetchAPI(endpoint, options = {}) {
            try {
                const url = endpoint.startsWith('http') ? endpoint : `${apiBase}${endpoint}`;
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return await response.json();
            } catch (e) {
                console.error('API Error:', e);
                updateConnectionStatus(false);
                return null;
            }
        }

        function updateConnectionStatus(ok) {
            const el = document.getElementById('connection-status');
            if (ok) {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span><span>已连接</span>';
                el.className = 'flex items-center space-x-2 text-sm px-3 py-1.5 rounded-full bg-emerald-500/10 text-emerald-400 border border-emerald-500/20';
            } else {
                el.innerHTML = '<span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span><span>连接断开</span>';
                el.className = 'flex items-center space-x-2 text-sm px-3 py-1.5 rounded-full bg-red-500/10 text-red-400 border border-red-500/20';
            }
        }

        async function loadDashboard() {
            const data = await fetchAPI('/api/server-status/json');
            if (data) {
                updateConnectionStatus(true);
                document.getElementById('stat-tasks').textContent = data.application.active_tasks;
                document.getElementById('stat-cpu').textContent = `${data.system.cpu_usage}%`;
                document.getElementById('stat-mem').textContent = `${data.memory.percent}%`;
                document.getElementById('stat-disk').textContent = `${(data.disk.free / 1024 / 1024 / 1024).toFixed(1)} GB`;
            }

            // In our system, tasks are currently fetched from the HTML page logic, 
            // we'll need an endpoint that returns all tasks as JSON.
            // Let's assume /api/status/all (which we might need to add or adapt)
            const tasks = await fetchAPI('/api/status/all_tasks'); // Hypothetical or to be added
            if (tasks) renderTaskList(tasks);
        }

        function renderTaskList(tasks) {
            const container = document.getElementById('task-list');
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div class="py-20 text-center text-slate-500"><i class="bi bi-inbox text-5xl mb-4 block"></i><p>暂无任务</p></div>';
                return;
            }

            container.innerHTML = tasks.map(task => `
                <div class="glass-card p-5 rounded-2xl flex flex-col md:flex-row md:items-center justify-between gap-4 hover:border-primary/30 transition-all group">
                    <div class="flex items-center space-x-4">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center ${getStatusColor(task.status)} bg-opacity-10">
                            <i class="bi ${getStatusIcon(task.status)} text-xl"></i>
                        </div>
                        <div>
                            <p class="font-semibold text-slate-100 truncate max-w-[200px] md:max-w-md" title="${task.url}">${task.url}</p>
                            <p class="text-xs text-slate-500 mt-1 font-mono">${task.id.slice(0,8)}... | ${task.status.toUpperCase()}</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button onclick="viewTask('${task.id}')" class="p-2.5 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-300 transition-colors" title="查看日志">
                            <i class="bi bi-terminal-fill"></i>
                        </button>
                        ${task.status === 'running' ? `
                            <button onclick="controlTask('${task.id}', 'pause')" class="p-2.5 rounded-xl bg-amber-500/10 hover:bg-amber-500/20 text-amber-500 transition-colors">
                                <i class="bi bi-pause-fill"></i>
                            </button>
                        ` : ''}
                        ${task.status === 'paused' ? `
                            <button onclick="controlTask('${task.id}', 'resume')" class="p-2.5 rounded-xl bg-emerald-500/10 hover:bg-emerald-500/20 text-emerald-500 transition-colors">
                                <i class="bi bi-play-fill"></i>
                            </button>
                        ` : ''}
                        <button onclick="deleteTask('${task.id}')" class="p-2.5 rounded-xl bg-red-500/10 hover:bg-red-500/20 text-red-500 transition-colors">
                            <i class="bi bi-trash3-fill"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function getStatusColor(status) {
            switch(status) {
                case 'running': return 'bg-primary text-primary';
                case 'completed': return 'bg-emerald-500 text-emerald-500';
                case 'failed': return 'bg-red-500 text-red-500';
                case 'paused': return 'bg-amber-500 text-amber-500';
                default: return 'bg-slate-500 text-slate-500';
            }
        }

        function getStatusIcon(status) {
            switch(status) {
                case 'running': return 'bi-arrow-repeat animate-spin';
                case 'completed': return 'bi-check-lg';
                case 'failed': return 'bi-exclamation-triangle';
                case 'paused': return 'bi-pause-circle';
                default: return 'bi-clock';
            }
        }

        async function submitNewTask() {
            const url = document.getElementById('new-url').value;
            const downloader = document.getElementById('new-downloader').value;
            const service = document.getElementById('new-service').value;
            const path = document.getElementById('new-path').value;
            const compress = document.getElementById('new-compress').checked;

            if (!url) return alert('请输入 URL');

            // API expects Form Data for create_download_job
            const formData = new FormData();
            formData.append('url', url);
            formData.append('downloader', downloader);
            formData.append('upload_service', service);
            formData.append('upload_path', path);
            formData.append('enable_compression', compress ? 'true' : 'false');

            const res = await fetch(`${apiBase}/api/download`, {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                document.getElementById('new-task-modal').classList.add('hidden');
                loadDashboard();
            } else {
                alert('任务提交失败');
            }
        }

        async function deleteTask(id) {
            if (!confirm('确定删除此任务？')) return;
            await fetchAPI(`/api/delete/${id}`, { method: 'POST' });
            loadDashboard();
        }

        async function controlTask(id, action) {
            await fetchAPI(`/api/${action}/${id}`, { method: 'POST' });
            loadDashboard();
        }

        function saveConfig() {
            const base = document.getElementById('api-base').value;
            if (base) {
                localStorage.setItem('wdm_api_base', base);
                apiBase = base;
                document.getElementById('config-modal').classList.add('hidden');
                loadDashboard();
            }
        }

        // Initialize
        document.getElementById('api-base').value = apiBase;
        loadDashboard();
        setInterval(loadDashboard, 5000);

    </script>
</body>
</html>